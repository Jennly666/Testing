# ДОКУМЕНТАЦИЯ ПО ТЕСТИРОВАНИЮ ПРОГРАММНОГО СРЕДСТВА

## 1. WHITE-BOX ТЕСТИРОВАНИЕ

### Выбранная функция для анализа: UserRepository.update()

```python
async def update(
    self,
    id: int,
    user_update: UserUpdate,
    session: AsyncSession
):
    user = await self.get_by_id(id, session)                    # 1
    if user is None:                                            # 2
        raise HTTPException(status_code=status.HTTP_404_NOT_FOUND, 
                          detail=f"Пользователь с id {id} не найден")  # 3
    update_data = user_update.model_dump(exclude_unset=True)    # 4
    
    if "email" in update_data:                                  # 5
        existing_user = await self.get_by_email(update_data["email"], session)  # 6
        if existing_user and existing_user.id != id:            # 7
            raise HTTPException(status_code=status.HTTP_400_BAD_REQUEST, 
                              detail="Этот email уже занят")    # 8
    
    for key, value in update_data.items():                      # 9 (цикл 1)
        setattr(user, key, value)                               # 10
        
    user.updated_at = datetime.now()                            # 11
    await session.commit()                                      # 12
    await session.refresh(user)                                 # 13
    return user                                                 # 14
```

### Граф потока управления (Flow Graph)

```
    [1] ──→ [2] ──→ [3] (Exception)
             │
             ↓ (user exists)
            [4] ──→ [5] ──→ [6] ──→ [7] ──→ [8] (Exception)
             │       │               │
             │       │               ↓ (email ok)
             │       │              [9] ←──┐
             │       │               │     │ (цикл)
             │       │               ↓     │
             │       │              [10] ──┘
             │       │               │
             │       ↓ (no email)    │
             │      [9] ←────────────┘
             │       │
             │       ↓
             │      [10] (если есть элементы)
             │       │
             ↓       ↓
            [11] ──→ [12] ──→ [13] ──→ [14]
```

### Цикломатическая сложность

**Способ 1: Формула M = E - N + 2P**
- E (рёбра) = 15
- N (узлы) = 12  
- P (компоненты связности) = 1
- M = 15 - 12 + 2(1) = 5

**Способ 2: Количество решений + 1**
- Решения: if user is None (1), if "email" in update_data (2), if existing_user and existing_user.id != id (3), for loop (4)
- M = 4 + 1 = 5

**Способ 3: Количество предикатных узлов + 1**
- Предикатные узлы: [2], [5], [7], [9]
- M = 4 + 1 = 5

### Базис независимых путей

1. **Путь 1**: 1→2→3 (пользователь не найден)
2. **Путь 2**: 1→2→4→5→11→12→13→14 (обновление без email)
3. **Путь 3**: 1→2→4→5→6→7→8 (email уже занят)
4. **Путь 4**: 1→2→4→5→6→7→9→10→11→12→13→14 (обновление с email, цикл выполняется)
5. **Путь 5**: 1→2→4→5→6→7→9→11→12→13→14 (обновление с email, цикл не выполняется)

## 2. BLACK-BOX ТЕСТИРОВАНИЕ

### Выбранная функция: UserRegister.username_validator()

#### Эквивалентные классы:

**Корректные классы:**
- EC1: Валидные имена пользователей (буквы и цифры, не только цифры)
  - Примеры: "user123", "TestUser", "abc123def"

**Некорректные классы:**
- EC2: Пустые значения
  - Примеры: "", None
- EC3: Только цифры
  - Примеры: "123", "999"
- EC4: Содержат специальные символы
  - Примеры: "user@123", "test_user", "user-name"

#### Граничные значения:

- BV1: Минимальная длина (1 символ): "a"
- BV2: Максимальная длина (30 символов): "a" * 30
- BV3: Превышение максимальной длины: "a" * 31
- BV4: Пустая строка: ""
- BV5: Только одна цифра: "1"
- BV6: Только буквы: "abc"

#### Тестовые случаи:

| Тест | Входные данные | Ожидаемый результат | Класс |
|------|----------------|-------------------|-------|
| T1   | "user123"      | Успех             | EC1   |
| T2   | "TestUser"     | Успех             | EC1   |
| T3   | ""             | ValueError        | EC2   |
| T4   | "123"          | ValueError        | EC3   |
| T5   | "user@123"     | ValueError        | EC4   |
| T6   | "test_user"    | ValueError        | EC4   |
| T7   | "a"            | Успех             | BV1   |
| T8   | "1"            | ValueError        | BV5   |

## 3. СТРАТЕГИЯ ТЕСТИРОВАНИЯ

### Общая стратегия тестирования системы управления пользователями

#### 3.1 Unit Testing (Модульное тестирование)
**Цель**: Проверка отдельных функций и методов
**Охват**:
- Валидаторы моделей Pydantic
- Утилитарные функции (hash_password, validate_password, to_camel_case)
- Методы репозиториев
- Бизнес-логика сервисов

**Инструменты**: pytest, pytest-asyncio
**Критерии покрытия**: минимум 80% покрытия кода

#### 3.2 Integration Testing (Интеграционное тестирование)
**Цель**: Проверка взаимодействия между компонентами
**Охват**:
- Взаимодействие Service ↔ Repository
- Взаимодействие API ↔ Service
- Взаимодействие с базой данных

**Подходы**:
- Bottom-up: от репозиториев к сервисам, затем к API
- Big Bang: тестирование всей системы сразу для критических путей

#### 3.3 System Testing (Системное тестирование)
**Цель**: Проверка системы в целом
**Охват**:
- End-to-end сценарии пользователей
- Производительность системы
- Безопасность (аутентификация, авторизация)

#### 3.4 Validation Testing (Валидационное тестирование)
**Цель**: Соответствие требованиям
**Охват**:
- Функциональные требования
- Требования безопасности
- Требования производительности

### Тактика тестирования

1. **Статическое тестирование**: Анализ кода, code review
2. **Динамическое тестирование**: Выполнение тестов
3. **Позитивное тестирование**: Проверка корректных сценариев
4. **Негативное тестирование**: Проверка обработки ошибок
5. **Граничное тестирование**: Проверка крайних значений

## 4. ТЕСТ-КЕЙСЫ И ЧЕК-ЛИСТЫ

### Функция для тестирования: Управление ролями пользователей

#### 4.1 Тест-кейсы

**Тест-кейс 1: Создание новой роли**
- **Название**: TC_ROLE_CREATE_001
- **Предусловия**: Система запущена, есть доступ к API
- **Входные данные**: 
  ```json
  {
    "roleName": "MODERATOR",
    "roleDescription": "Модератор форума"
  }
  ```
- **Шаги выполнения**:
  1. Отправить POST запрос на /api/v1/roles/
  2. Проверить статус ответа
  3. Проверить содержимое ответа
- **Ожидаемый результат**: 
  - Статус: 201 Created
  - Ответ содержит ID созданной роли
- **Фактический результат**: _Заполняется при выполнении_
- **Статус**: _Заполняется при выполнении_

**Тест-кейс 2: Создание роли с дублирующимся именем**
- **Название**: TC_ROLE_CREATE_002
- **Предусловия**: Роль "USER" уже существует в системе
- **Входные данные**:
  ```json
  {
    "roleName": "USER",
    "roleDescription": "Дублирующая роль"
  }
  ```
- **Шаги выполнения**:
  1. Отправить POST запрос на /api/v1/roles/
  2. Проверить статус ответа
  3. Проверить сообщение об ошибке
- **Ожидаемый результат**:
  - Статус: 400 Bad Request
  - Сообщение об ошибке о дублировании
- **Фактический результат**: _Заполняется при выполнении_
- **Статус**: _Заполняется при выполнении_

**Тест-кейс 3: Назначение роли пользователю**
- **Название**: TC_ROLE_ASSIGN_001
- **Предусловия**: 
  - Пользователь с ID=1 существует
  - Роль с ID=2 существует
- **Входные данные**: user_id=1, role_id=2
- **Шаги выполнения**:
  1. Отправить PATCH запрос на /api/v1/roles/set-role/1/2
  2. Проверить статус ответа
  3. Проверить обновление роли пользователя
- **Ожидаемый результат**:
  - Статус: 200 OK
  - Роль пользователя изменена
- **Фактический результат**: _Заполняется при выполнении_
- **Статус**: _Заполняется при выполнении_

**Тест-кейс 4: Назначение несуществующей роли**
- **Название**: TC_ROLE_ASSIGN_002
- **Предусловия**: Пользователь с ID=1 существует
- **Входные данные**: user_id=1, role_id=999 (несуществующий)
- **Шаги выполнения**:
  1. Отправить PATCH запрос на /api/v1/roles/set-role/1/999
  2. Проверить статус ответа
  3. Проверить сообщение об ошибке
- **Ожидаемый результат**:
  - Статус: 404 Not Found
  - Сообщение об отсутствии роли
- **Фактический результат**: _Заполняется при выполнении_
- **Статус**: _Заполняется при выполнении_

#### 4.2 Чек-листы

**Чек-лист 1: Функциональность управления ролями**

- [ ] Система позволяет создавать новые роли
- [ ] Система предотвращает создание ролей с дублирующимися именами
- [ ] Система позволяет получать список всех ролей
- [ ] Система позволяет получать роль по ID
- [ ] Система позволяет удалять роли
- [ ] Система позволяет назначать роли пользователям
- [ ] Система проверяет существование пользователя при назначении роли
- [ ] Система проверяет существование роли при назначении
- [ ] Система логирует все операции с ролями
- [ ] Система корректно обрабатывает ошибки базы данных

**Чек-лист 2: Безопасность и валидация ролей**

- [ ] Имена ролей проходят валидацию на корректность
- [ ] Система не позволяет создавать роли с пустыми именами
- [ ] Система не позволяет создавать роли со слишком длинными именами
- [ ] Описания ролей проходят валидацию
- [ ] Система корректно обрабатывает SQL-инъекции в именах ролей
- [ ] Система логирует попытки несанкционированного доступа
- [ ] Система возвращает корректные HTTP статус-коды
- [ ] Система не раскрывает внутреннюю структуру в сообщениях об ошибках
- [ ] Операции с ролями требуют соответствующих прав доступа
- [ ] Система корректно обрабатывает одновременные запросы на создание ролей

## 5. ЗАКЛЮЧЕНИЕ

Данная документация описывает комплексный подход к тестированию системы управления пользователями, включающий:

1. **White-box тестирование** с анализом цикломатической сложности и построением базиса независимых путей
2. **Black-box тестирование** с использованием методов эквивалентных классов и граничных значений
3. **Стратегию тестирования** на всех уровнях (unit, integration, system, validation)
4. **Практические тест-кейсы и чек-листы** для функциональности управления ролями
